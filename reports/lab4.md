# chapter6练习
## 编程作业
### 硬链接

硬链接要求两个不同的目录项指向同一个文件，在我们的文件系统中也就是两个不同名称目录项指向同一个磁盘块。

本节要求实现三个系统调用 `sys_linkat、sys_unlinkat、sys_stat` 。

**linkat**：

syscall ID: 37

功能：创建一个文件的一个硬链接， [linkat标准接口](https://linux.die.net/man/2/linkat) 。

首先要在layout层中，对每一个`DiskInode`添加硬连接数字段。一开始想通过Arc计数来判断连接数，发现计数只能作用于os层，不能正确说明文件系统中的磁盘上的硬链接数。

`Inode`是在vfs中对`DiskInode`的抽象，因此添加硬连接字段后，每创建一个`Inode`即初始化`DiskInode`时记得将硬连接数置为1。每次硬连接创建时并不创建新的`Inode`，而是创建一个新的目录项。

先在`sys_linkat`中翻译出新旧文件名，如果相同则直接返回-1。然后在根节点(本实验文件系统只有根目录)下调用创建硬连接方法。如果连接的新文件名已存在则直接返回-1。

在排除了以上的错误后，获取`inode_id`在磁盘上找到`Inode`对应的`DiskInode`读入内存，将其硬连接数加一，然后在目录中添加新的目录项。最后刷新磁盘缓冲，返回硬连接数。


**unlinkat**:

 - syscall ID: 35
     
 - 功能：取消一个文件路径到文件的链接, [unlinkat标准接口](https://linux.die.net/man/2/unlinkat) 。

解除硬连接即删除目录项。首先判断目录项是否存在，然后将所有目录项读入一个数组除了要删除的目录项只保存下他的`inode_id`，然后将删掉解除的硬连接目录项的数组写回磁盘。接下来根据这个`id`找到对应的`DiskInode`，将其硬连接计数减一。最后判断硬连接数是否归零，如果归零还得将`DiskInode`删除。刷新磁盘缓存，返回硬连接数。
     

**fstat**:

 - syscall ID: 80
     
 - 功能：获取文件状态。
     
     
在vfs中添加获取当前`inode`所对应的`disknode`相关信息的方法`stat`。在os中为`File`trait添加`stat`方法，这样直接调用进程文件描述符表中存储对象的`stat`方法就行。


## 问答作业

1. 在我们的easy-fs中，root inode起着什么作用？如果root inode中的内容损坏了，会发生什么？

root inode作为根目录文件夹类型的`Inode`节点，保存了当前目录下的所有目录项。如果损坏了，当前目录下所有文件都将无法索引到正确的磁盘数据。

2. 举出使用 pipe 的一个实际应用的例子。


shell 中的管道操作符 |：

```shell
ls | grep .txt
```

在这个例子中，ls 命令列出当前目录中的所有文件，然后通过管道将这个列表传递给 grep .txt 命令。grep .txt 命令从管道中读取数据，然后搜索包含 .txt 的行，也就是所有的 .txt 文件。


## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 **以下各位** 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：
    

    
2. 此外，我也参考了 **以下资料** ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：
    
[rCore Learning](https://sjodqtoogh.feishu.cn/docx/FICVde0z2okapCxTecPcCRoRnSd) 

[rCore文件系统 easy-fs](https://sjodqtoogh.feishu.cn/docx/GbxNduOvDotgUTxrfqycjkXJncf) 

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。